version: '3.8'

# docker-compose.diffusion.yml
# DiffusionPolicy Server 的 Docker Compose 配置

services:
  # DiffusionPolicy Server for Lift task
  diffusion-server-lift:
    build:
      context: .
      dockerfile: Dockerfile.diffusion
    container_name: diffusion-policy-lift
    ports:
      - "8000:8000"
    environment:
      TASK: lift
      MODEL_PATH: checkpoints/lift_real/checkpoint-best
      DEVICE: cuda
      PYTHONUNBUFFERED: 1
    volumes:
      - ./checkpoints:/app/checkpoints:ro
      - ./datasets:/app/datasets:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - diffusion-network
    profiles:
      - lift

  # DiffusionPolicy Server for Sort task
  diffusion-server-sort:
    build:
      context: .
      dockerfile: Dockerfile.diffusion
    container_name: diffusion-policy-sort
    ports:
      - "8001:8000"
    environment:
      TASK: sort
      MODEL_PATH: checkpoints/sort_real/checkpoint-best
      DEVICE: cuda
      PYTHONUNBUFFERED: 1
    volumes:
      - ./checkpoints:/app/checkpoints:ro
      - ./datasets:/app/datasets:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - diffusion-network
    profiles:
      - sort

  # DiffusionPolicy Server for Stack task
  diffusion-server-stack:
    build:
      context: .
      dockerfile: Dockerfile.diffusion
    container_name: diffusion-policy-stack
    ports:
      - "8002:8000"
    environment:
      TASK: stack
      MODEL_PATH: checkpoints/stack_real/checkpoint-best
      DEVICE: cuda
      PYTHONUNBUFFERED: 1
    volumes:
      - ./checkpoints:/app/checkpoints:ro
      - ./datasets:/app/datasets:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - diffusion-network
    profiles:
      - stack

networks:
  diffusion-network:
    driver: bridge
